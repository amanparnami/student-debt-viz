<!DOCTYPE html>
<!-- TODO 
	* Draw a stack bar chart
	** draw x and y axis (done)
	** read data and handle null values (done)
	*** 74 schools with no aid data (done)
	**** remove them: 992 rows remain (done)
	*** Some schools with parts of data missing 
	**** wherever there is a null preceded by zero then insert zero
	* Make it interactive
	* handle the 74 schools that were removed earlier
	* brushing (done)
	
-->
<meta charset="utf-8">
<style>

	body {
		font: 10px sans-serif;
	}

	.axis path,
	.axis line {
		fill: none;
		stroke: #000;
		shape-rendering: crispEdges;
	}

	.bar {
		fill: steelblue;
	}

	.x.axis path {

	}
	
	.brush .extent {
		stroke: #fff;
		fill-opacity: .125;
		shape-rendering: crispEdges;
	}

</style>
<body>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script>
		$(document).ready(function() {
			var cmargin = {top: 20, right: 10, bottom: 20, left: 40},
			fmargin = {top: 220, right: 10, bottom: 20, left: 40},
			cwidth = 1043 - cmargin.left - cmargin.right,
			fwidth = 343 - fmargin.left - fmargin.right,
			cheight = 200 - cmargin.top - cmargin.bottom,
			fheight = 500 - fmargin.top - fmargin.bottom;
	
			var cx = d3.scale.ordinal().rangeRoundBands([0, cwidth], .1),
			fx = d3.scale.ordinal().rangeRoundBands([0, fwidth], .1),
			cy = d3.scale.linear().range([cheight, 0]),
			fy = d3.scale.linear().range([fheight, 0]);
	
			var cxAxis = d3.svg.axis()
			.scale(cx)
			.orient("bottom")
			.tickFormat(function(d){return "";});
		
			var fxAxis = d3.svg.axis()
			.scale(fx)
			.orient("bottom")
			.tickFormat(function(d){return "";});

			var cyAxis = d3.svg.axis()
			.scale(cy)
			.orient("left")
			.tickFormat(function(d) { return Math.round(d / 1e3) + "K"; });
									
			var fyAxis = d3.svg.axis()
			.scale(fy)
			.orient("left")
			.tickFormat(function(d) { return Math.round(d / 1e3) + "K"; });
	
			// An SVG element with a top-left origin .
			var svg = d3.select("body").append("svg")
			.attr("width", cwidth + cmargin.left + cmargin.right)
			.attr("height",fheight + fmargin.top + fmargin.bottom)
	
			var context = svg.append("g")
			.attr("id", "context")
			.attr("transform", "translate(" + cmargin.left + "," + cmargin.top + ")");
				
			var focus = svg.append("g")
			.attr("id","focus")
			.attr("transform", "translate(" + fmargin.left + "," + fmargin.top + ")");
	
			var color = d3.scale.ordinal()
			.range(["#8a89a6", "#ff8c00"]);
			

			d3.csv("data/2011_aid_less_schools.csv", function(error,csvData) {
				color.domain(["average_amount_any_loan_aid", "average_amount_any_grant_aid"]);

				// Convert strings to numbers.
				csvData.forEach(function(d, i) {
					if(d.average_amount_any_loan_aid == "") {
						d.average_amount_any_loan_aid = +0;
					}
					d.average_amount_any_loan_aid = +d.average_amount_any_loan_aid;
					if(d.average_amount_any_grant_aid == "") {
						d.average_amount_any_grant_aid = +0;
					}
					d.average_amount_any_grant_aid = +d.average_amount_any_grant_aid;
					var y0 = 0;
					d.amounts = color.domain().map(function(name) { return {name: name, y0: y0, y1: y0 += +d[name]}});
					d.total = d.amounts[d.amounts.length - 1].y1;
				});
									
				csvData.sort(function(a, b) { return a.total - b.total; });
		
				cx.domain(csvData.map(function(d) { return d.id; }));
				cy.domain([0,d3.max(csvData, function(d) { return d.total; })]);
				//fx.domain(cx.domain());
				fy.domain(cy.domain());
												
				drawContext(csvData);
				
				//Initialize focus with 20 values
				fx.domain(cx.domain().slice(20,40));
				drawFocus(csvData.slice(20,40));
			
			});//d3.csv
	
			function drawContext(csvData) {
				var contextChart = context.selectAll("g").data(csvData);
				var brush = d3.svg.brush().x(cx).extent([20,40]).on("brush", brushed);
				var contextChartEnter = context.selectAll("g")
				.data(csvData)
				.enter().append("g")
				.attr("class", "bar1")
				.attr("transform", function(d) { return "translate(" + cx(d.id) + ",0)"; });
				
				//Rendering first layer
				contextChartEnter.append("rect")
				.attr("width", cx.rangeBand())
				.attr("y", function(d) { return cy(d.amounts[0].y1); })
				.attr("height", function(d) { return cy(d.amounts[0].y0) - cy(d.amounts[0].y1); })
				.style("fill", function(d) { return color(d.amounts[0].name); });
						
				//Rendering second layer													
				contextChartEnter.append("rect")
				.attr("width", cx.rangeBand())
				.attr("y", function(d) { return cy(d.amounts[1].y1); })
				.attr("height", function(d) { return cy(d.amounts[1].y0) - cy(d.amounts[1].y1); })
				.style("fill", function(d) { return color(d.amounts[1].name); });	
				
				//set-up brush
				context.append("g")
				.attr("class", "x brush")
				.call(brush)
				.selectAll("rect")
				.attr("y", -6)
				.attr("height", cheight + 7);
				
				
				function brushed() {
				    var s = d3.event.target.extent();
				    if (s[1]-s[0] < fwidth) {
							fx.domain(brush.empty() ? cx.domain() : cx.domain().slice(s[0], s[1]));	
							focus.select(".x.axis").call(fxAxis);
				      drawFocus(csvData.slice(s[0],s[1]));							
				    } else{
							//Restrict the size of brush to the width of focus area
							d3.event.target.extent([s[0],s[0]+fwidth-1]); 
							d3.event.target(d3.select(this));
						}
				}
													
				// contextChart.exit().remove();
				// contextChart.order();												
			}
	
			function drawFocus(csvData) {
				//Clean the leftovers
				focus.selectAll("g").remove();
				
				//Redraw everything
				var focusChart = focus.selectAll("g").data(csvData);
				var focusChartEnter = focus.selectAll("g")
				.data(csvData)
				.enter().append("g")
				.attr("class", "bar2")
				.attr("transform", function(d) { return "translate(" + fx(d.id) + ",0)"; });
				
				//Rendering first layer
				focusChartEnter.append("rect")
				.attr("width", fx.rangeBand())
				.attr("y", function(d) { return fy(d.amounts[0].y1); })
				.attr("height", function(d) { return fy(d.amounts[0].y0) - fy(d.amounts[0].y1); })
				.style("fill", function(d) { return color(d.amounts[0].name); });
						
				//Rendering second layer													
				focusChartEnter.append("rect")
				.attr("width", fx.rangeBand())
				.attr("y", function(d) { return fy(d.amounts[1].y1); })
				.attr("height", function(d) { return fy(d.amounts[1].y0) - fy(d.amounts[1].y1); })
				.style("fill", function(d) { return color(d.amounts[1].name); });	
								
				focusChart.exit().remove();
				focusChart.order();
			}
			

		}); //(document)
	
	</script>
	<div>
		<div class="left-sidebar context">
		
		</div>
		<div class="right-sidebar controls">
		</div>
	</div>

</body>
